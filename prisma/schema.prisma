generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserType {
  BUYER
  SELLER
}

enum CategoryName {
  TOP
  BOTTOM
  DRESS
  OUTER
  SKIRT
  SHOES
  ACC
}

enum InquiryStatus {
  WaitingAnswer // 답변 대기
  CompletedAnswer // 답변 완료
}

enum PaymentStatus {
  WaitingPayment // 결제 대기
  CompletedPayment // 결제 완료
  CancelledPayment // 결제 취소
}

// 등급 마스터 데이터
model Grade {
  id        String @id @default(cuid())
  name      String @unique
  rate      Int // 할인율 또는 적립률 (%)
  minAmount Int // 등급 달성 최소 금액

  users User[]

  @@map("grades")
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  name         String
  password     String
  type         UserType @default(BUYER)
  points       Int      @default(0)
  image        String   @default("")
  gradeId      String?
  refreshToken String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  grade          Grade?         @relation(fields: [gradeId], references: [id], onDelete: SetNull)
  store          Store?
  favoriteStores UserLike[]
  cart           Cart?
  orders         Order[]
  inquiries      Inquiry[]
  inquiryReplies InquiryReply[]
  reviews        Review[]
  notifications  Notification[]

  @@index([email])
  @@index([gradeId])
  @@map("users")
}

model Store {
  id            String   @id @default(cuid())
  name          String
  address       String
  detailAddress String? // 프론트엔드에서 옵셔널로 처리
  phoneNumber   String
  content       String   @db.Text
  image         String   @default("") // 프론트엔드에서 필수로 처리, 기본값 빈 문자열
  userId        String   @unique // 사용자당 1개의 스토어만 가능
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user          User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  favoriteUsers UserLike[]
  products      Product[]
  orderItems    OrderItem[]
  inquiries     Inquiry[]

  @@index([userId])
  @@map("stores")
}

// 관심 스토어
model UserLike {
  storeId   String
  userId    String
  createdAt DateTime @default(now())

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, storeId])
  @@index([storeId])
  @@index([userId])
  @@map("user_likes")
}

model Size {
  id Int    @id @default(autoincrement())
  en String @unique // "Free", "XS", "S", "M", "L", "XL"
  ko String @unique

  stocks     Stock[]
  cartItems  CartItem[]
  orderItems OrderItem[]

  @@map("sizes")
}

// 상품
model Product {
  id                String       @id @default(cuid())
  name              String
  price             Int
  content           String?      @db.Text
  image             String?
  discountRate      Int          @default(0)
  discountStartTime DateTime?
  discountEndTime   DateTime?
  isSoldOut         Boolean      @default(false)
  storeId           String? // nullable: 스토어 삭제 시 상품 기록 보존
  categoryName      CategoryName // 상품의 단일 카테고리
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  avgRating         Float        @default(0)
  reviewCount       Int          @default(0)
  salesCount        Int          @default(0)

  store      Store?      @relation(fields: [storeId], references: [id], onDelete: SetNull)
  stocks     Stock[]
  inquiries  Inquiry[]
  reviews    Review[]
  cartItems  CartItem[]
  orderItems OrderItem[]

  @@index([storeId])
  @@index([createdAt])
  @@map("products")
}

model Stock {
  id        String  @id @default(cuid())
  productId String? // nullable: 상품 삭제 시 재고 기록 보존
  sizeId    Int
  quantity  Int     @default(0)

  product Product? @relation(fields: [productId], references: [id], onDelete: SetNull)
  size    Size     @relation(fields: [sizeId], references: [id])

  @@unique([productId, sizeId])
  @@index([productId])
  @@index([sizeId])
  @@map("stocks")
}

// 상품 문의
model Inquiry {
  id        String        @id @default(cuid())
  title     String
  content   String        @db.Text
  isSecret  Boolean
  status    InquiryStatus @default(WaitingAnswer)
  userId    String? // nullable: 유저 삭제 시 문의 이력 보존
  productId String? // nullable: 상품 삭제 시 문의 이력 보존
  storeId   String? // nullable: 상품 삭제 시 문의의 스토어 이력 보존
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  user    User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  product Product?      @relation(fields: [productId], references: [id], onDelete: SetNull)
  store   Store?        @relation(fields: [storeId], references: [id], onDelete: SetNull)
  reply   InquiryReply?

  @@index([userId])
  @@index([productId])
  @@index([storeId])
  @@index([status])
  @@map("inquiries")
}

// 문의 답변
model InquiryReply {
  id        String   @id @default(cuid())
  content   String   @db.Text
  inquiryId String?  @unique // nullable: 문의 삭제 시 답변 보존
  userId    String? // nullable: 답변 작성자 삭제 시 답변 보존
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  inquiry Inquiry? @relation(fields: [inquiryId], references: [id], onDelete: SetNull)
  user    User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([inquiryId])
  @@index([userId])
  @@map("inquiry_replies")
}

// 리뷰
model Review {
  id          String   @id @default(cuid())
  rating      Float // 평점 (1.0 ~ 5.0)
  content     String?  @db.Text
  userId      String? // nullable: 유저 삭제 시 리뷰 보존
  productId   String? // nullable: 상품 삭제 시 리뷰 보존
  orderItemId String   @unique // 주문 아이템당 1개의 리뷰만 작성 가능
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user      User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  product   Product?  @relation(fields: [productId], references: [id], onDelete: SetNull)
  orderItem OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([productId])
  @@index([rating])
  @@map("reviews")
}

// 장바구니
model Cart {
  id        String   @id @default(cuid())
  buyerId   String   @unique // 구매자당 1개의 장바구니
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  buyer User       @relation(fields: [buyerId], references: [id], onDelete: Cascade)
  items CartItem[]

  @@map("carts")
}

// 장바구니 아이템
model CartItem {
  id        String   @id @default(cuid())
  cartId    String
  productId String
  sizeId    Int
  quantity  Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  cart    Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product Product? @relation(fields: [productId], references: [id], onDelete: Cascade)
  size    Size     @relation(fields: [sizeId], references: [id])

  @@unique([cartId, productId, sizeId])
  @@index([cartId])
  @@index([productId])
  @@map("cart_items")
}

// 주문
model Order {
  id            String   @id @default(cuid())
  name          String // 주문자 이름
  phoneNumber   String
  address       String
  subtotal      Int // 총 주문 금액
  totalQuantity Int // 총 수량
  usePoint      Int      @default(0) // 사용한 포인트
  buyerId       String? // nullable: 유저 삭제 시 주문 기록 보존
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  buyer      User?       @relation(fields: [buyerId], references: [id], onDelete: SetNull)
  orderItems OrderItem[]
  payment    Payment?

  @@index([buyerId])
  @@index([createdAt])
  @@map("orders")
}

model OrderItem {
  id         String  @id @default(cuid())
  orderId    String? // nullable: 주문 삭제 시 주문 아이템 보존
  productId  String? // nullable: 상품 삭제 시 주문 내역 보존
  sizeId     Int
  price      Int // 주문 당시 가격
  quantity   Int
  isReviewed Boolean @default(false)
  productName String
  productImage String?
  storeId     String?

  store   Store?    @relation(fields: [storeId], references: [id], onDelete: SetNull)
  order   Order?   @relation(fields: [orderId], references: [id], onDelete: SetNull)
  product Product? @relation(fields: [productId], references: [id], onDelete: SetNull)
  size    Size     @relation(fields: [sizeId], references: [id])
  review  Review?

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

model Payment {
  id        String        @id @default(cuid())
  orderId   String?       @unique // nullable: 주문 삭제 시 결제 기록 보존
  price     Int
  status    PaymentStatus @default(WaitingPayment)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  order Order? @relation(fields: [orderId], references: [id], onDelete: SetNull)

  @@index([orderId])
  @@index([status])
  @@map("payments")
}

// 알람
model Notification {
  id        String   @id @default(cuid())
  userId    String
  content   String   @db.Text
  isSent    Boolean  @default(false)
  isChecked Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isChecked])
  @@map("notifications")
}
